# Balance Microservice

![Build Status](https://github.com/phlx/balance-go/workflows/validate-markdown/badge.svg)

## –ß—Ç–æ —ç—Ç–æ?

–≠—Ç–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, 
—Å–¥–µ–ª–∞–Ω–Ω—ã–π –ø–æ [—Ç–µ—Å—Ç–æ–≤–æ–º—É –∑–∞–¥–∞–Ω–∏—é](https://github.com/avito-tech/job-backend-trainee-assignment) 
—Ä–∞–¥–∏ —Ñ–∞–Ω–∞.  
–ù–∞–ø–∏—Å–∞–Ω –Ω–∞ Go 1.15.  

## –ß—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å?

Git, —á—Ç–æ–±—ã —Å–∫–∞—á–∞—Ç—å —ç—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.  
Docker –∏ Docker Compose, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë –Ω—É–∂–Ω–æ–µ
–≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–µ.  
–≠—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.  
–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Go –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–µ–±–∞–≥–∞.  
–î–ª—è –¥—Ä—É–≥–∏—Ö –≤–µ—â–µ–π –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –∏–º–µ—Ç—å Unix-–ø–æ–¥–æ–±–Ω–æ–µ 
–æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Makefiles.  
–ù–∞ Windows —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å [WSL2](https://docs.microsoft.com/en-us/windows/wsl/compare-versions#whats-new-in-wsl-2),
–∞ –∑–Ω–∞—á–∏—Ç –≤ Unix-–ø–æ–¥–æ–±–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –º–æ–∂–Ω–æ –∑–∞–π—Ç–∏ –∫–æ–º–∞–Ω–¥–æ–π `wsl`.  
–†–∞–∑—É–º–µ–µ—Ç—Å—è, –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ [—É—Å—Ç–∞–Ω–æ–≤–∏–≤ WSL](https://docs.microsoft.com/ru-ru/windows/wsl/install-win10).  

## –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å?
–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ –¥–ª—è Docker Compose:
```bash
docker-compose up -d
```
–¢–æ –∂–µ —Å–∞–º–æ–µ –¥–µ–ª–∞–µ—Ç –∫–æ–º–∞–Ω–¥–∞
```bash
make
```

## –ö–∞–∫ –ø–æ—Ç—ã–∫–∞—Ç—å—Å—è?
–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–æ –∞–¥—Ä–µ—Å—É [http://localhost](http://localhost)
–¥–æ—Å—Ç—É–ø–µ–Ω Swagger UI —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π [—Å—Ö–µ–º–æ–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞](api/swagger.json).  
–¢–∞–∫–∂–µ, –æ–ø–∏—Å–∞–Ω–∏–µ API –µ—Å—Ç—å –≤ –≤–∏–¥–µ [–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ Postman](https://documenter.getpostman.com/view/6261504/TVKD2czt).  
–°–∞–º–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Å–≤–æ–π Postman
–Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥–µ [api/balance.postman_collection.json](api/balance.postman_collection.json).  

## –ê –∑–∞—á–µ–º Graphite –∏ Grafana?
–ü–æ –∞–¥—Ä–µ—Å—É [http://localhost:3030](http://localhost:3030)
–º–æ–∂–Ω–æ –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å Graphite, –∞ –ø–æ –∞–¥—Ä–µ—Å—É [http://localhost:3080](http://localhost:3080)
–Ω–∞—Ö–æ–¥–∏—Ç—Å—è Grafana.  
Graphite —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å –ø–æ–º–æ—â—å—é Statsd. –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –µ—Å—Ç—å
–Ω–µ–º–Ω–æ–≥–æ –º–µ—Å—Ç, –≥–¥–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–æ—Å—Ç–µ–π—à–∏–µ –º–µ—Ç—Ä–∏–∫–∏.  
–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –º–µ—Ç—Ä–∏–∫–∏ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á–µ—Ä–µ–∑ —Å–∞–º Graphite.  
–õ–∏–±–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏—Ö –ø—Ä–æ—Å–º–æ—Ç—Ä —á–µ—Ä–µ–∑ Grafana, –≥–¥–µ –º–æ–∂–Ω–æ 
–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –±–æ–≥–∞—Ç—ã–µ –∏ –∫—Ä–∞—Å–∏–≤—ã–µ –¥–∞—à–±–æ—Ä–¥—ã.

## –ê –ø–æ—á–µ–º—É –¥–∞—à–±–æ—Ä–¥—ã –≤ Grafana –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã?
–ú–Ω–µ –±—ã–ª–æ –ª–µ–Ω—å —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è —Å –Ω–∏–º–∏. üôÇ  
–¢–∞–∫ –∏ –±—ã—Ç—å ‚Äî `// TODO: –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–º–ø–æ—Ä—Ç –¥–∞—à–±–æ—Ä–¥–æ–≤ –≤ Grafana`  
–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫ Grafana –Ω—É–∂–Ω—ã–π source 
–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ [http://localhost:3080/datasources](http://localhost:3080/datasources).  
–ù–∞–∂–∞—Ç—å `Add data source`, –≤—ã–±—Ä–∞—Ç—å `Graphite` –∏ –≤ —Ä–∞–∑–¥–µ–ª–µ `HTTP`
–≤ –ø–æ–ª–µ `URL` –ø—Ä–æ–ø–∏—Å–∞—Ç—å –∞–¥—Ä–µ—Å `http://graphite:80`.  
–ò –¥–∞–ª–µ–µ —É–∂–µ –ø–æ–∏–≥—Ä–∞—Ç—å—Å—è —Å –¥–∞—à–±–æ—Ä–¥–∞–º–∏.

## –ö–∞–∫–∏–µ –µ—â—ë –∫–æ–º–∞–Ω–¥—ã –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω—ã?
–ë—ã—Å—Ç—Ä—ã–π –æ–±–∑–æ—Ä –∫–æ–º–∞–Ω–¥ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å –ø–æ–º–æ—â—å—é
```bash
make help
```
–ö–æ–º–∞–Ω–¥–∞ –≤—ã–≤–µ–¥–µ—Ç –∫–æ–º–∞–Ω–¥—ã –∏ –∏—Ö –æ–ø–∏—Å–∞–Ω–∏–µ:
```bash
help             This help overview
run              Run application in Docker Compose
build            Build application via Docker Compose
rerun            Stop Docker Compose, build application container, run Docker Compose
test             Run all tests inside app container
fmt              Run fmt with latest docker image of golang
lint             Run lint with latest image of golangci/golangci-lint
concurrent-test  Run test for concurrent transactions in PostgreSQL, see internal/postgres/isolation.go
```

## –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–µ–±–∞–≥–∞ ‚Äî —ç—Ç–æ –∫–∞–∫?
–í –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
–∏ –µ–≥–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –≤–∏–¥–µ PostgreSQL, Redis –∏ StatsD.  
–ü—Ä–∏ —ç—Ç–æ–º —Å–∞–º–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ app –∏ –≤—ã–≤–µ–¥–µ–Ω–æ
–Ω–∞—Ä—É–∂—É —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç 3000.  

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–Ω–æ –¥–µ–±–∞–∂–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ JetBrains Goland.  
–î–ª—è —ç—Ç–æ–≥–æ –≤ IDE –Ω—É–∂–Ω–æ [–ø–æ—Å—Ç–∞–≤–∏—Ç—å breakpoint –≤ –Ω—É–∂–Ω–æ–º –º–µ—Å—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
main/service/main.go](https://blog.jetbrains.com/go/2019/02/06/debugging-with-goland-getting-started/#debugging-an-application).
–ü—Ä–∏ —ç—Ç–æ–º –≤ [—Å–æ–∑–¥–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–µ–±–∞–≥–∞](https://www.jetbrains.com/help/go/creating-run-debug-configuration-for-tests.html#test-configuration-for-a-package)
–Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ –ø–æ–ª–µ Program arguments –∑–Ω–∞—á–µ–Ω–∏–µ `--debug=true`.  

–ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–æ –≤–∫–ª—é—á–µ–Ω–Ω—ã–º —Ñ–ª–∞–≥–æ–º `debug` –∑–∞—Å—Ç–∞–≤–∏—Ç –µ–≥–æ
–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∞–π–ª –æ–∫—Ä—É–∂–µ–Ω–∏—è `configs/.env.debug`, –±–ª–∞–≥–æ–¥–∞—Ä—è —á–µ–º—É —Å–∞–º–æ
–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ —Ç–µ–∫—É—â–µ–π (—Ö–æ—Å—Ç–æ–≤–æ–π) –º–∞—à–∏–Ω–µ,
–Ω–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –æ–Ω–æ –±—É–¥–µ—Ç –∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º —É–∂–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö
Docker Compose.

## –ö–∞–∫ –º–æ–∂–Ω–æ –≤–∫—Ä–∞—Ç—Ü–µ –æ–ø–∏—Å–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞?
–†–æ—É—Ç–∏–Ω–≥ –∏ –º–µ—Ö–∞–Ω–∏–∑–º middleware –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç gin.  
–ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ middleware cors, idempotency –∏ logger:
- CORS –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–ª—è Swagger UI –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –æ—Ç localhost:80 –¥–æ localhost:3000.  
- Idempotency —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞ POST-–∑–∞–ø—Ä–æ—Å–∞—Ö –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
–¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö idempotence key.  
- Logger –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –æ–±—â–µ–≥–æ –ª–æ–≥–≥–µ—Ä–∞ 
(–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Logrus) –∏ –≤—ã–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω—É–∂–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –∏ –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.  

–í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –Ω–æ –æ–Ω –Ω–µ –∏–º–µ–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏
Dependency Injection. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ ‚Äî —É—Å–ª–æ–≤–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
–¥–ª—è –æ–±—ä–µ–∫—Ç–∞, —Å–æ–±–∏—Ä–∞—é—â–µ–≥–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —è–≤–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –ø—Ä–æ–∫–∏–¥—ã–≤–∞—é—â–µ–≥–æ
–∏—Ö –≤ –Ω—É–∂–Ω—ã–µ –º–µ—Ç–æ–¥—ã.

–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–æ–±—Ä–∞–Ω–∞ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ ‚Äî —ç—Ç–æ
internal/services/core/service. –ú–µ—Ç–æ–¥–∞–º —ç—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞ –≤—Ö–æ–¥ –ø–æ—Å—Ç—É–ø–∞—é—Ç
—É–∂–µ –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

–í–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–æ–π –¥–∞–Ω–Ω—ã—Ö –∑–∞–Ω–∏–º–∞—é—Ç—Å—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ internal/controllers.
–í –∫–∞—á–µ—Å—Ç–≤–µ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è go-playground/validator.

CoreService –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã –≤—Å–µ—Ö –Ω—É–∂–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –±–∞–ª–∞–Ω—Å–æ–º.
–í –º–µ—Ç–æ–¥–µ Get() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ–∫–∏–Ω—É—Ç—ã–π –≤ coreService –∫–ª–∏–µ–Ω—Ç –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç exchangeRatesService.
–í—Å–µ –º–µ—Ç–æ–¥—ã coreService –¥–µ–ª–∞—é—Ç –∑–∞–ø—Ä–æ—Å—ã –≤ Postgres —Å –ø–æ–º–æ—â—å—é –ø–∞–∫–µ—Ç–∞ go-pg, –∏—Å–ø–æ–ª—å–∑—É—è 
–º–æ–¥–µ–ª–∏ –∫–∞—Ç–∞–ª–æ–≥–∞ internal/models.
–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥–µ–ª—è–º —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞—é—Ç—Å—è (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–∏—Å–∞. 

–í –∫–∞—á–µ—Å—Ç–≤–µ –∫–ª–∏–µ–Ω—Ç–∞ Redis –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–∞–∫–µ—Ç go-redis –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è 
–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (internal/middlewares/idempotency.go) –∏ –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è 
–∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç (internal/exchangerates/service.go).

–î–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ shopspring/decimal.  
–û–Ω–∞ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞ IEEE 754 (Floating-Point Arithmetic).  
–ü—Ä–∏–º–µ—Ä: –ø—Ä–∏–±–∞–≤–ª–µ–Ω–∏–µ –∫ 0 —á–∏—Å–ª–∞ 0.1 —Ç—ã—Å—è—á—É —Ä–∞–∑ –≤–º–µ—Å—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ 
—á–∏—Å–ª–∞ 10 [–≤—ã–¥–∞—Å—Ç 9.999999999999831](https://play.golang.org/p/TQBd4yJe6B).  
–¢–∞–∫–∂–µ, –¥–ª—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–Ω–∫–æ–≤—Å–∫–æ–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ (–¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ —á—ë—Ç–Ω–æ–≥–æ) 
–¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è.

## –ê —á—Ç–æ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –∏ MVCC?
–û—à–∏–±–∫–∞ ["–≥—Ä—è–∑–Ω–æ–≥–æ" —á—Ç–µ–Ω–∏—è](https://postgrespro.ru/docs/postgrespro/12/transaction-iso) –∏—Å–∫–ª—é—á–µ–Ω–∞ –±–ª–∞–≥–æ–¥–∞—Ä—è 
—É—Ä–æ–≤–Ω—é –∏–∑–æ–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `READ COMMITTED` –∏ –∑–∞–ø—Ä–æ—Å—É `SELECT ... FOR UPDATE`.
–ó–∞–ø—Ä–æ—Å —Å `FOR UPDATE` –≤ –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏—Ö —É—Ä–æ–≤–Ω—è—Ö –∏–∑–æ–ª—è—Ü–∏–∏ 
[–±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏](https://postgrespro.ru/docs/postgrespro/12/explicit-locking#LOCKING-ROWS).  

–≠—Ç–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–∏–º–∞ –∫ —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ –º–Ω–æ–≥–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –º–æ–≥—É—Ç 
—É–≤–µ—Å—Ç–∏ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–∏–Ω—É—Å, –≤ —Ç–æ –≤—Ä–µ–º—è –∫–∞–∫ –æ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ –Ω—É–ª—è.  
–≠–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–∫—É—é —Å–∏—Ç—É–∞—Ü–∏—é –º–æ–∂–Ω–æ —Å –ø–æ–º–æ—â—å—é —Å–∫—Ä–∏–ø—Ç–∞
```bash
make concurrent-test
```
–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
- –ó–∞—á–∏—Å–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å id 99999999 100 —Ä—É–±–ª–µ–π
- –í—ã–≤–æ–¥–∏—Ç –±–∞–ª–∞–Ω—Å
- –î–µ—Å—è—Ç—å —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ —Å —Ä–∞–∑–Ω–∏—Ü–µ–π –≤ 100 –º—Å –ø—ã—Ç–∞–µ—Ç—Å—è —Å–ø–∏—Å–∞—Ç—å –ø–æ 50 —Ä—É–±–ª–µ–π, 
—Å–æ–≤–µ—Ä—à–∞—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞–¥–µ—Ä–∂–∫—É –Ω–∞ —Å–µ–∫—É–Ω–¥—É –º–µ–∂–¥—É —á—Ç–µ–Ω–∏–µ–º –±–∞–ª–∞–Ω—Å–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º 
–Ω–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –∏ –¥–µ–π—Å—Ç–≤–∏—è (–º–æ–¥–µ–ª–∏ transaction)
- –í–Ω–æ–≤—å –≤—ã–≤–æ–¥–∏—Ç –±–∞–ª–∞–Ω—Å

–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞–≤–µ–Ω –Ω—É–ª—é –∏ —Å–æ–∑–¥–∞–Ω–∞ –æ–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 
–∑–∞—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞ 100 —Ä—É–±–ª–µ–π –∏ –¥–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–ø–∏—Å–∞–Ω–∏—è –ø–æ 50 —Ä—É–±–ª–µ–π.  
–í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ "–≥—Ä—è–∑–Ω–æ–≥–æ" —á—Ç–µ–Ω–∏—è –≤ —Ç–∞–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –±–∞–ª–∞–Ω—Å –º–æ–≥ –±—ã –æ—Å—Ç–∞—Ç—å—Å—è –Ω—É–ª–µ–≤—ã–º, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º 
—Å–æ–∑–¥–∞–ª–∏—Å—å –ª–∏ –±—ã –ª–∏—à–Ω–∏–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –ø–æ –∫–æ—Ç–æ—Ä—ã–º —Å—É–º–º–∞ –Ω–µ –±—ã–ª–∞ –±—ã —Ä–∞–≤–Ω–∞ –±–∞–ª–∞–Ω—Å—É.

## –ü–æ—á–µ–º—É –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ—á–µ—Ä–µ–¥–∏?
–°–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ üôÇ  
–ï—Å–ª–∏ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –Ω–∞ –Ω–µ–≥–æ –æ—Ç–≤–µ—Ç –æ —Ç–æ–º, —á—Ç–æ –∑–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –æ—á–µ—Ä–µ–¥—å, —Ç–æ –∫–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º
–∏ –∫—É–¥–∞ —É–≤–µ–¥–æ–º–ª—è—Ç—å –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏?  

–û—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –Ω–µ–æ—á–µ–≤–∏–¥–µ–Ω.
–î–ª—è —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å websockets, –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∏ —É–≤–µ–¥–æ–º–ª—è—Ç—å –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø–æ –¥—É–ø–ª–µ–∫—Å–Ω–æ–º—É –∫–∞–Ω–∞–ª—É,
–Ω–æ —ç—Ç–æ —É–∂–µ –Ω–µ HTTP API, –∞ HTTP + WS API.  
–¢–∞–∫–æ–µ —É—Å–ª–æ–∂–Ω–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª—è–µ—Ç –∫—É—á—É —Ä–∞–±–æ—Ç—ã –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–∞–∫–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.

–í —Ç–µ–∫—É—â–µ–º –≤–∏–¥–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –≤ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–º —ç–∫–∑–µ–º–ø–ª—è—Ä–µ –≤ –î–æ–∫–µ—Ä–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç ~3-3,5k –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
–Ω–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —é–∑–µ—Ä—É —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
–°–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ, —á—Ç–æ –≤ –±–æ–µ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ —Ç–∞–∫–æ–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –º–æ–∂–µ—Ç —Å—Ç–æ–ª–∫–Ω—É—Ç—å—Å—è —Å –ø—Ä–æ–±–ª–µ–º–æ–π –≤—ã—Å–æ–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫.

–°–µ—Ç–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, –ø—Ä–∏ –∫–æ—Ç–æ—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç —É–π—Ç–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Ä–µ—à–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é –∫–ª—é—á–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.
–í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –¥–∞–∂–µ –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–∞—Ö –Ω–µ –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–∫–∞—Ö –∑–∞–ø—Ä–æ—Å–∞.

## –ê –≥–¥–µ unit –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã?
ü§∑

–í –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å –ø–∞—Ä–∞ –Ω–µ–±–æ–ª—å—à–∏—Ö —Ç–µ—Å—Ç–æ–≤.  

–í —Ü–µ–ª–æ–º, —Å–ª–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å –∫–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞ 
—Ç—Ä–µ–±—É—é—Ç —é–Ω–∏—Ç-—Ç–µ—Å—Ç–æ–≤.
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å coreService —Å –ø–æ–º–æ—â—å—é —Ç–∞–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤ –¥–æ–≤–æ–ª—å–Ω–æ
—Å–ª–æ–∂–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–∏–¥—ë—Ç—Å—è –ø–æ–¥—Å–æ–≤—ã–≤–∞—Ç—å –∑–∞–≥–ª—É—à–∫–∏
redis, postgres –∏ –ø—Ä–æ—á–∏—Ö, –∏ –ø—Ä–∏ —ç—Ç–æ–º —ç–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏—Ö —Ä–∞–±–æ—Ç—É.

–ü—Ä–æ—â–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑–µ.
–¢–µ—Å—Ç–æ–≤–∞—è –±–∞–∑–∞ —É–∂–µ –µ—Å—Ç—å ‚Äî —ç—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä postgres_test.  

–ù–æ —Ç–∞–∫–∏–µ —Ç–µ—Å—Ç—ã —Å–∫–æ—Ä–µ–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —Ç–µ—Å—Ç–∞–º.  
–ö–∞–∫ –º–Ω–µ –∫–∞–∂–µ—Ç—Å—è, –∏–º–µ–µ—Ç —Å–º—ã—Å–ª —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–æ API –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞.

–í –ª—é–±–æ–º —Å–ª—É—á–∞–µ, `// TODO –Ω–∞–ø–∏—Å–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã`
